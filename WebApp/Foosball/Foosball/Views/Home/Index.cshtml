@{
    ViewData["Title"] = "Dashboard";
}
<div class="">
    <div class="page-title">
        <div class="title_left">
            <h3>@ViewData["Title"]</h3>
        </div>
    </div>

    @{Html.RenderPartial("Index/_Tiles");}

    <div class="row">
        <div class="col-md-8">
            <div class="row">
                <div class="col-md-6">
                    @{Html.RenderPartial("Index/_TopPlayers");}
                </div>
                <div class="col-md-6">
                    @{Html.RenderPartial("Index/_TopTeams");}
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    @{Html.RenderPartial("Index/_CompletedMatches");}
                </div>
            </div>      
        </div>
        <div class="col-md-4">
            @{Html.RenderPartial("Index/_Livegoals");}
        </div>
    </div>

    @section scripts {
        <script src="~/js/signalr-client.min.js"></script>
        <!--Add script to update the page and send messages.-->
        <script type="text/javascript">
            let goalConnection = new signalR.HubConnection('/goal');

            var liveGoalContainer = $('#livegoals-list');
            goalConnection.on('goalScored', goal => {
                if (!goal || !goal.Player || !goal.Match)
                    return;

                //append goal data to container
                $('<li>').
                    append($('<div>')
                        .addClass('block')
                        .append($('<div>')
                            .addClass('block_container')
                            .append($('<h2>')
                                .addClass('title')
                                .append($('<a>')
                                    .css("color", goal.TeamColor == 0 ? "black" : "grey")
                                    //.css("font-weight","bold")
                                    .html('<i class="fa fa-futbol-o"></i>&nbsp;Goal scored by ' + goal.Player.Name + '!')    
                                )
                            )
                            .append($('<div>')
                                .addClass('byline')
                                .html('<time class="timeago" datetime="' + goal.CreatedAt + '"></time>')
                            )
                            .append($('<p>')
                                .addClass('excerpt')
                                .html('<a class="pull-right">Match&nbsp;Details</a>')
                            )
                        )
                    ).hide()
                    .prependTo(liveGoalContainer)
                    .fadeIn("slow");

                //only keep last 5 entries
                liveGoalContainer.find("li").slice(5).remove();

                //hide info panel
                $('#livegoals-alert').hide();

                //initialize timeago
                $("time.timeago").timeago();

                //increment total goals
                var totalGoals = parseInt($('#totalGoalsCount').text());
                $('#totalGoalsCount').text(totalGoals + 1);
            });

            goalConnection.start();

            let matchConnection = new signalR.HubConnection('/match');
            matchConnection.on('crawl', data => {
                activateSiren();
            });

             matchConnection.on('matchCompleted', match => {
                 if (!match || !match.LastUpdatedAt)
                    return;

                //append goal data to container
                $('<li>').
                    append($('<div>')
                        .addClass('block')
                        .append($('<div>')
                            .addClass('block_container')
                            .append($('<h2>')
                                .addClass('title')
                                .append($('<a>')
                                    .css("font-weight","bold")
                                    .html('<i class="fa fa-flag-checkered"></i>&nbsp;Match completed!')
                                )
                            )
                            .append($('<div>')
                                .addClass('byline')
                                .html('<time class="timeago" datetime="' + match.LastUpdatedAt + '"></time>')
                            )
                            .append($('<p>')
                                .addClass('excerpt')
                                .html('<a class="pull-right">Match&nbsp;Details</a>')
                            )
                        )
                    ).hide()
                    .prependTo(liveGoalContainer)
                    .fadeIn("slow");

                //only keep last 5 entries
                liveGoalContainer.find("li").slice(5).remove();

                //hide info panel
                $('#livegoals-alert').hide();

                //initialize timeago
                $("time.timeago").timeago();

                //increment total matches
                var totalMatches = parseInt($('#totalMatchesCount').text());
                $('#totalMatchesCount').text(totalMatches + 1);

            });

             matchConnection.start();
                 //.then(() => matchConnection.invoke('matchCompleted', 'Welcome!'));
        </script>
    }
</div>
